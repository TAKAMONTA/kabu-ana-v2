const { test, expect } = require('@playwright/test');
const axios = require('axios');

// PayPal Sandboxç’°å¢ƒã®è¨­å®š
const PAYPAL_CONFIG = {
  clientId: process.env.PAYPAL_CLIENT_ID || 'your-sandbox-client-id',
  clientSecret: process.env.PAYPAL_CLIENT_SECRET || 'your-sandbox-client-secret',
  baseURL: 'https://api-m.sandbox.paypal.com',
  mode: 'sandbox'
};

// ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã™ã‚‹é–¢æ•°
async function getPayPalAccessToken() {
  const auth = Buffer.from(`${PAYPAL_CONFIG.clientId}:${PAYPAL_CONFIG.clientSecret}`).toString('base64');
  
  try {
    const response = await axios.post(
      `${PAYPAL_CONFIG.baseURL}/v1/oauth2/token`,
      'grant_type=client_credentials',
      {
        headers: {
          'Authorization': `Basic ${auth}`,
          'Content-Type': 'application/x-www-form-urlencoded'
        }
      }
    );
    
    return response.data.access_token;
  } catch (error) {
    console.error('Failed to get PayPal access token:', error.response?.data || error.message);
    throw error;
  }
}

// ãƒ—ãƒ©ãƒ³æƒ…å ±
const TEST_PLAN = {
  id: process.env.PAYPAL_TEST_PLAN_ID || 'P-5ML4271244454362WXNWU5NQ', // å®Ÿéš›ã®ãƒ—ãƒ©ãƒ³IDã«ç½®ãæ›ãˆã‚‹
  name: 'Test Subscription Plan'
};

test.describe('PayPal Sandbox Integration Tests', () => {
  let accessToken;

  test.beforeAll(async () => {
    // PayPalèªè¨¼æƒ…å ±ã®ç¢ºèª
    if (!process.env.PAYPAL_CLIENT_ID || !process.env.PAYPAL_CLIENT_SECRET) {
      console.warn('âš ï¸  PayPal credentials not found in environment variables');
      console.warn('Please set PAYPAL_CLIENT_ID and PAYPAL_CLIENT_SECRET');
      console.warn('Skipping PayPal integration tests...');
      test.skip();
    }

    // ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
    console.log('ğŸ” Getting PayPal access token...');
    accessToken = await getPayPalAccessToken();
    console.log('âœ… Access token obtained');
  });

  test('should create a subscription using PayPal API', async ({ request }) => {
    console.log('ğŸ§ª Starting PayPal subscription creation test');

    // 1. ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½œæˆ
    const subscriptionData = {
      plan_id: TEST_PLAN.id,
      subscriber: {
        name: {
          given_name: 'Test',
          surname: 'User'
        },
        email_address: `test-${Date.now()}@example.com`
      },
      application_context: {
        brand_name: 'AI Stock Test',
        locale: 'ja-JP',
        shipping_preference: 'NO_SHIPPING',
        user_action: 'SUBSCRIBE_NOW',
        return_url: 'http://localhost:3000/subscription/success',
        cancel_url: 'http://localhost:3000/subscription/cancel'
      }
    };

    console.log('ğŸ“¤ Creating subscription with data:', JSON.stringify(subscriptionData, null, 2));

    const createResponse = await request.post(`${PAYPAL_CONFIG.baseURL}/v1/billing/subscriptions`, {
      headers: {
        'Authorization': `Bearer ${accessToken}`,
        'Content-Type': 'application/json',
        'PayPal-Request-Id': `test-${Date.now()}` // å†ªç­‰æ€§ã®ãŸã‚
      },
      data: subscriptionData
    });

    expect(createResponse.status()).toBe(201);
    
    const subscription = await createResponse.json();
    console.log('âœ… Subscription created:', subscription.id);
    console.log('ğŸ“‹ Subscription status:', subscription.status);

    // ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³IDã¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç¢ºèª
    expect(subscription).toHaveProperty('id');
    expect(subscription).toHaveProperty('status');
    expect(subscription.status).toBe('APPROVAL_PENDING');

    // 2. ä½œæˆã—ãŸã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã®è©³ç´°ã‚’å–å¾—
    console.log('ğŸ” Getting subscription details...');
    
    const detailsResponse = await request.get(
      `${PAYPAL_CONFIG.baseURL}/v1/billing/subscriptions/${subscription.id}`,
      {
        headers: {
          'Authorization': `Bearer ${accessToken}`,
          'Content-Type': 'application/json'
        }
      }
    );

    expect(detailsResponse.status()).toBe(200);
    
    const subscriptionDetails = await detailsResponse.json();
    console.log('ğŸ“Š Subscription details:', JSON.stringify(subscriptionDetails, null, 2));

    // è©³ç´°æƒ…å ±ã®æ¤œè¨¼
    expect(subscriptionDetails.id).toBe(subscription.id);
    expect(subscriptionDetails.plan_id).toBe(TEST_PLAN.id);
    expect(subscriptionDetails.subscriber.email_address).toContain('test-');
  });

  test('should handle subscription with your app API', async ({ request, page }) => {
    console.log('ğŸ§ª Testing subscription confirmation with app API');

    // 1. ã¾ãšPayPalã§ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½œæˆ
    const subscriptionData = {
      plan_id: TEST_PLAN.id,
      subscriber: {
        name: {
          given_name: 'Integration',
          surname: 'Test'
        },
        email_address: `integration-test-${Date.now()}@example.com`
      },
      application_context: {
        brand_name: 'AI Stock Test',
        locale: 'ja-JP',
        shipping_preference: 'NO_SHIPPING',
        user_action: 'SUBSCRIBE_NOW',
        return_url: 'http://localhost:3000/subscription/success',
        cancel_url: 'http://localhost:3000/subscription/cancel'
      }
    };

    const createResponse = await request.post(`${PAYPAL_CONFIG.baseURL}/v1/billing/subscriptions`, {
      headers: {
        'Authorization': `Bearer ${accessToken}`,
        'Content-Type': 'application/json',
        'PayPal-Request-Id': `integration-test-${Date.now()}`
      },
      data: subscriptionData
    });

    const subscription = await createResponse.json();
    console.log('âœ… Test subscription created:', subscription.id);

    // 2. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®APIã§ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’ç¢ºèª
    // å®Ÿéš›ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒå‹•ä½œã—ã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
    const appApiUrl = process.env.APP_API_URL || 'http://localhost:3000';
    
    try {
      const confirmResponse = await request.post(`${appApiUrl}/api/paypal/subscription/confirm`, {
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer test-token' // å®Ÿéš›ã®èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ãŒå¿…è¦ãªå ´åˆ
        },
        data: {
          subscriptionID: subscription.id,
          planId: TEST_PLAN.id,
          planName: TEST_PLAN.name,
          orderID: `ORDER-${Date.now()}`
        }
      });

      // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’æ¤œè¨¼
      if (confirmResponse.status() === 200) {
        const responseData = await confirmResponse.json();
        console.log('âœ… App API response:', responseData);
        
        expect(responseData).toHaveProperty('success', true);
        expect(responseData).toHaveProperty('subscriptionId', subscription.id);
      } else {
        console.warn('âš ï¸  App API returned status:', confirmResponse.status());
        const errorData = await confirmResponse.text();
        console.warn('Error response:', errorData);
      }
    } catch (error) {
      console.warn('âš ï¸  Could not connect to app API:', error.message);
      console.warn('Make sure your application is running on', appApiUrl);
    }
  });

  test('should verify subscription webhook', async ({ request }) => {
    console.log('ğŸ§ª Testing PayPal webhook verification');

    // Webhookã‚¤ãƒ™ãƒ³ãƒˆã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
    const webhookEvent = {
      id: 'WH-TEST-EVENT-001',
      event_type: 'BILLING.SUBSCRIPTION.ACTIVATED',
      resource_type: 'subscription',
      resource: {
        id: 'I-TEST-SUBSCRIPTION',
        plan_id: TEST_PLAN.id,
        status: 'ACTIVE',
        subscriber: {
          email_address: 'webhook-test@example.com'
        }
      }
    };

    // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®Webhookã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ãƒ†ã‚¹ãƒˆ
    const appApiUrl = process.env.APP_API_URL || 'http://localhost:3000';
    
    try {
      const webhookResponse = await request.post(`${appApiUrl}/api/paypal/webhook`, {
        headers: {
          'Content-Type': 'application/json',
          'PayPal-Transmission-Id': 'test-transmission-id',
          'PayPal-Transmission-Time': new Date().toISOString(),
          'PayPal-Transmission-Sig': 'test-signature' // å®Ÿéš›ã«ã¯æ¤œè¨¼ãŒå¿…è¦
        },
        data: webhookEvent
      });

      console.log('ğŸ“¨ Webhook response status:', webhookResponse.status());
      
      if (webhookResponse.status() === 200) {
        console.log('âœ… Webhook processed successfully');
      } else {
        const responseText = await webhookResponse.text();
        console.warn('âš ï¸  Webhook response:', responseText);
      }
    } catch (error) {
      console.warn('âš ï¸  Could not test webhook endpoint:', error.message);
    }
  });

  test('should list active subscriptions', async ({ request }) => {
    console.log('ğŸ§ª Listing active subscriptions');

    const listResponse = await request.get(
      `${PAYPAL_CONFIG.baseURL}/v1/billing/subscriptions?plan_id=${TEST_PLAN.id}&status=ACTIVE`,
      {
        headers: {
          'Authorization': `Bearer ${accessToken}`,
          'Content-Type': 'application/json'
        }
      }
    );

    expect(listResponse.status()).toBe(200);
    
    const subscriptionsList = await listResponse.json();
    console.log('ğŸ“‹ Active subscriptions count:', subscriptionsList.subscriptions?.length || 0);
    
    if (subscriptionsList.subscriptions && subscriptionsList.subscriptions.length > 0) {
      console.log('ğŸ“Š Sample subscription:', subscriptionsList.subscriptions[0]);
    }
  });
});

// E2Eãƒ•ãƒ­ãƒ¼ãƒ†ã‚¹ãƒˆï¼ˆUIã‚’å«ã‚€ï¼‰
test.describe('PayPal Subscription E2E Flow', () => {
  test.skip('should complete full subscription flow', async ({ page }) => {
    // ã“ã®ãƒ†ã‚¹ãƒˆã¯å®Ÿéš›ã®UIãŒå¿…è¦ãªãŸã‚ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒå‹•ä½œã—ã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
    
    // 1. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹
    await page.goto('http://localhost:3000/subscription');
    
    // 2. ãƒ—ãƒ©ãƒ³ã‚’é¸æŠ
    await page.click('[data-plan-id="standard"]');
    
    // 3. PayPalãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
    await page.click('#paypal-button');
    
    // 4. PayPalã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’å‡¦ç†
    const [paypalPopup] = await Promise.all([
      page.waitForEvent('popup'),
      page.click('#paypal-button')
    ]);
    
    // 5. PayPal Sandboxã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³
    await paypalPopup.fill('#email', process.env.PAYPAL_SANDBOX_BUYER_EMAIL || 'buyer@example.com');
    await paypalPopup.fill('#password', process.env.PAYPAL_SANDBOX_BUYER_PASSWORD || 'password');
    await paypalPopup.click('#btnLogin');
    
    // 6. ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ‰¿èª
    await paypalPopup.waitForSelector('#confirmButtonTop');
    await paypalPopup.click('#confirmButtonTop');
    
    // 7. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«æˆ»ã£ã¦æˆåŠŸã‚’ç¢ºèª
    await page.waitForURL('**/subscription/success');
    await expect(page.locator('.success-message')).toContainText('ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãŒæ­£å¸¸ã«é–‹å§‹ã•ã‚Œã¾ã—ãŸ');
  });
});
