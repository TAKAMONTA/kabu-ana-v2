const { test, expect } = require('@playwright/test');
const express = require('express');
const bodyParser = require('body-parser');

// ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ¢ãƒƒã‚¯ã‚µãƒ¼ãƒãƒ¼ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
let server;

test.describe('PayPal Subscription API', () => {
  const apiEndpoint = '/api/paypal/subscription/confirm';
  // ç’°å¢ƒå¤‰æ•°ã§ãƒãƒ¼ãƒˆã‚’ç®¡ç†ï¼ˆCI/CDç’°å¢ƒã§ã®ç«¶åˆå›é¿ï¼‰
  const mockServerPort = process.env.TEST_SERVER_PORT || 3333;
  // IPv4ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ˜ç¤ºçš„ã«æŒ‡å®šï¼ˆWebKitã§ã®IPv6æ¥ç¶šå•é¡Œã‚’å›é¿ï¼‰
  const baseURL = `http://127.0.0.1:${mockServerPort}`;

  test.beforeAll(async () => {
    // ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ¢ãƒƒã‚¯ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•
    const app = express();
    app.use(bodyParser.json());

    // ãƒ¢ãƒƒã‚¯APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
    app.post(apiEndpoint, (req, res) => {
      const { subscriptionID, planId, planName } = req.body;
      
      // å¿…é ˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ãƒã‚§ãƒƒã‚¯
      if (!subscriptionID || !planId) {
        return res.status(400).json({
          success: false,
          error: 'å¿…è¦ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™'
        });
      }

      // æˆåŠŸãƒ¬ã‚¹ãƒãƒ³ã‚¹
      res.json({
        success: true,
        message: 'ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãŒæ­£å¸¸ã«ç¢ºèªãƒ»ä¿å­˜ã•ã‚Œã¾ã—ãŸ',
        subscriptionId: subscriptionID,
        planId: planId,
        planName: planName || 'ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰',
        status: 'ACTIVE',
        user: {
          id: 'user_123',
          email: 'test@example.com'
        },
        timestamp: new Date().toISOString()
      });
    });

    // ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
    app.get('/api/health', (req, res) => {
      res.json({ status: 'OK' });
    });

    // ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•
    return new Promise((resolve) => {
      server = app.listen(mockServerPort, () => {
        console.log(`Test server running on http://localhost:${mockServerPort}`);
        resolve();
      });
    });
  });

  test.afterAll(async () => {
    // ãƒ†ã‚¹ãƒˆçµ‚äº†å¾Œã«ã‚µãƒ¼ãƒãƒ¼ã‚’é–‰ã˜ã‚‹
    if (server) {
      await new Promise((resolve) => server.close(resolve));
    }
  });

  test('should confirm a subscription successfully', async ({ request }) => {
    console.log('ğŸ§ª Test starting: should confirm a subscription successfully');
    
    const requestBody = {
      subscriptionID: 'MOCK_SUB_12345',
      planId: 'MOCK_PLAN_123',
      planName: 'ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰',
      orderID: 'MOCK_ORDER_12345'
    };
    
    console.log('ğŸ“¤ Request body:', JSON.stringify(requestBody, null, 2));
    console.log('ğŸ”— Full URL:', `${baseURL}${apiEndpoint}`);

    try {
      // å®Œå…¨ãªURLã‚’ä½¿ç”¨ã—ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
      const response = await request.post(`${baseURL}${apiEndpoint}`, {
        headers: {
          'Authorization': 'Bearer test-token-123',
          'Content-Type': 'application/json'
        },
        data: requestBody
      });
      
      console.log('ğŸ“Š Response status:', response.status());
      console.log('ğŸ“‹ Response headers:', response.headers());
      
      // ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å ´åˆã€ãƒœãƒ‡ã‚£ã‚’å‡ºåŠ›ã—ã¦ãƒ‡ãƒãƒƒã‚°
      if (response.status() !== 200) {
        const errorBody = await response.text();
        console.error('âŒ Error response body:', errorBody);
      }
      
      // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®æ¤œè¨¼
      expect(response.status()).toBe(200);
      
      const responseBody = await response.json();
      console.log('ğŸ“¦ Response body:', JSON.stringify(responseBody, null, 2));
      
      // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒœãƒ‡ã‚£ã«å¿…è¦ãªãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
      console.log('âœ… Checking response properties...');
      
      expect(responseBody).toHaveProperty('success', true);
      console.log('âœ… success property: OK');
      
      expect(responseBody).toHaveProperty('message', 'ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãŒæ­£å¸¸ã«ç¢ºèªãƒ»ä¿å­˜ã•ã‚Œã¾ã—ãŸ');
      console.log('âœ… message property: OK');
      
      expect(responseBody).toHaveProperty('subscriptionId', 'MOCK_SUB_12345');
      console.log('âœ… subscriptionId property: OK');
      
      expect(responseBody).toHaveProperty('planId', 'MOCK_PLAN_123');
      console.log('âœ… planId property: OK');
      
      console.log('ğŸ‰ Test completed successfully!');
      
    } catch (error) {
      console.error('âŒ Error details:', error.message);
      console.error('âŒ Stack trace:', error.stack);
      
      // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒã‚ã‚‹å ´åˆã¯ãã®å†…å®¹ã‚’è¡¨ç¤º
      if (error.response) {
        console.error('âŒ Error response status:', error.response.status);
        try {
          const errorBody = await error.response.text();
          console.error('âŒ Error response body:', errorBody);
        } catch (e) {
          console.error('âŒ Could not read error response body');
        }
      }
      
      throw error;
    }
  });

  test('should return an error if required parameters are missing', async ({ request }) => {
    console.log('ğŸ§ª Test starting: should return an error if required parameters are missing');
    
    const requestBody = {
      // planId ã¨ planName ãŒæ¬ ã‘ã¦ã„ã‚‹
      subscriptionID: 'TEST_SUB_INCOMPLETE'
    };
    
    console.log('ğŸ“¤ Request body (missing params):', JSON.stringify(requestBody, null, 2));

    try {
      // å®Œå…¨ãªURLã‚’ä½¿ç”¨ã—ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
      const response = await request.post(`${baseURL}${apiEndpoint}`, {
        headers: {
          'Authorization': 'Bearer dummy-test-token',
          'Content-Type': 'application/json'
        },
        data: requestBody
      });
      
      console.log('ğŸ“Š Response status:', response.status());

      // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ãŒ400ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
      expect(response.status()).toBe(400);

      const responseBody = await response.json();
      console.log('ğŸ“¦ Error response body:', JSON.stringify(responseBody, null, 2));

      // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒæ­£ã—ã„ã“ã¨ã‚’ç¢ºèª
      expect(responseBody).toHaveProperty('error', 'å¿…è¦ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™');
      
      console.log('ğŸ‰ Error test completed successfully!');
      
    } catch (error) {
      console.error('âŒ Error in error test:', error.message);
      throw error;
    }
  });
});
